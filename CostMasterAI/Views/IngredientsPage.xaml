<Page
    x:Class="CostMasterAI.Views.IngredientsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls"
    xmlns:helpers="using:CostMasterAI.Helpers" 
    mc:Ignorable="d">

    <Page.Resources>
        <helpers:BindingProxy x:Key="ViewModelProxy" Data="{Binding}" />
    </Page.Resources>

    <Grid Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Text="Supply Room ðŸ“¦ (Yield &amp; Pricing)" Style="{StaticResource TitleTextBlockStyle}" Margin="0,0,0,24"/>

        <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="12" Margin="0,0,0,24">
            <TextBox Header="Nama Bahan" Text="{Binding NewName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="200"/>
            <TextBox Header="Harga (Rp)" Text="{Binding NewPrice, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="120"/>
            <TextBox Header="Berat Kotor" Text="{Binding NewQty, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="100"/>
            <TextBox Header="Yield (%)" Text="{Binding NewYield, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="80" PlaceholderText="100"/>

            <ComboBox Header="Satuan" SelectedItem="{Binding NewUnit, Mode=TwoWay}" Width="100">
                <x:String>Gram</x:String>
                <x:String>ML</x:String>
                <x:String>Pcs</x:String>
                <x:String>Kg</x:String>
            </ComboBox>

            <Button Content="{Binding ButtonText}" Command="{Binding SaveOrUpdateIngredientCommand}" VerticalAlignment="Bottom" Style="{StaticResource AccentButtonStyle}"/>

            <Button Content="Batal" Command="{Binding CancelEditCommand}" VerticalAlignment="Bottom" 
                    Visibility="{Binding EditingId, Converter={StaticResource BoolVisConv}}"/>
        </StackPanel>

        <TabView Grid.Row="2" 
                 TabItemsSource="{Binding Tabs}" 
                 IsAddTabButtonVisible="True"
                 AddTabButtonClick="TabView_AddTabButtonClick"
                 TabCloseRequested="TabView_TabCloseRequested">

            <TabView.TabItemTemplate>
                <DataTemplate>
                    <TabViewItem IsClosable="{Binding IsClosable}">
                        <TabViewItem.IconSource>
                            <SymbolIconSource Symbol="{Binding Icon}"/>
                        </TabViewItem.IconSource>

                        <TabViewItem.Header>
                            <Grid>
                                <StackPanel Orientation="Horizontal" Spacing="8" 
                                            Visibility="{Binding IsNotEditing, Converter={StaticResource BoolVisConv}}"
                                            DoubleTapped="Header_DoubleTapped"
                                            Background="Transparent"
                                            ToolTipService.ToolTip="Klik 2x untuk ubah nama tab">

                                    <TextBlock Text="{Binding Header}" VerticalAlignment="Center"/>
                                </StackPanel>

                                <TextBox Text="{Binding Header, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                         Visibility="{Binding IsEditing, Converter={StaticResource BoolVisConv}}"
                                         KeyDown="HeaderTextBox_KeyDown"
                                         Width="150"/>
                            </Grid>
                        </TabViewItem.Header>

                        <TabViewItem.Content>
                            <controls:DataGrid ItemsSource="{Binding Ingredients}"
                                               AutoGenerateColumns="False"
                                               GridLinesVisibility="Horizontal"
                                               Margin="0,12,0,0">
                                <controls:DataGrid.Columns>
                                    <controls:DataGridTextColumn Header="Nama Bahan" Binding="{Binding Name}" Width="*"/>
                                    <controls:DataGridTextColumn Header="Harga Beli" Binding="{Binding PricePerPackage, Converter={StaticResource MoneyConv}}"/>
                                    <controls:DataGridTextColumn Header="Berat" Binding="{Binding QuantityPerPackage}"/>
                                    <controls:DataGridTextColumn Header="Unit" Binding="{Binding Unit}"/>

                                    <controls:DataGridTemplateColumn Header="Actions" Width="120">
                                        <controls:DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <Button Content="âœï¸" 
                                                            Command="{Binding Data.PrepareEditCommand, Source={StaticResource ViewModelProxy}}"
                                                            CommandParameter="{Binding}"
                                                            Background="Transparent" BorderThickness="0"/>
                                                    <Button Content="âŒ" 
                                                            Command="{Binding Data.DeleteIngredientCommand, Source={StaticResource ViewModelProxy}}"
                                                            CommandParameter="{Binding}"
                                                            Background="Transparent" BorderThickness="0"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </controls:DataGridTemplateColumn.CellTemplate>
                                    </controls:DataGridTemplateColumn>
                                </controls:DataGrid.Columns>
                            </controls:DataGrid>
                        </TabViewItem.Content>
                    </TabViewItem>
                </DataTemplate>
            </TabView.TabItemTemplate>
        </TabView>
    </Grid>
</Page>