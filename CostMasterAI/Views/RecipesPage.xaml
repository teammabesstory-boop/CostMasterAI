<Page
    x:Class="CostMasterAI.Views.RecipesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls"
    mc:Ignorable="d">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <Grid Grid.Column="0" Background="{ThemeResource SystemControlBackgroundChromeMediumLowBrush}" Padding="12">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <StackPanel Spacing="8">
                <TextBlock Text="Daftar Menu" Style="{StaticResource SubtitleTextBlockStyle}"/>

                <TextBox PlaceholderText="Nama Resep Baru..." 
                         Text="{Binding NewRecipeName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                <Button Content="Buat Resep" 
                        Command="{Binding CreateRecipeCommand}" 
                        HorizontalAlignment="Stretch"/>
            </StackPanel>

            <ListView Grid.Row="1" ItemsSource="{Binding Recipes}" SelectedItem="{Binding SelectedRecipe, Mode=TwoWay}" Margin="0,12,0,0">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Padding="8">
                            <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <TextBlock Text="HPP:" Opacity="0.6" FontSize="12"/>
                                <TextBlock Text="{Binding CostPerUnit, Converter={StaticResource MoneyConv}}" 
                                           Opacity="0.6" FontSize="12"/>
                            </StackPanel>
                        </StackPanel>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>

        <Grid Grid.Column="1" Padding="24">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <StackPanel Spacing="12" Margin="0,0,0,24">
                <TextBlock Text="{Binding SelectedRecipe.Name}" Style="{StaticResource TitleTextBlockStyle}"/>

                <Grid Background="{ThemeResource SystemControlBackgroundChromeMediumLowBrush}" Padding="12" CornerRadius="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="AI Actions:" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,8,0"/>

                        <Button Content="ðŸ“ Generate Deskripsi" 
                                Command="{Binding GenerateDescriptionCommand}" 
                                Style="{StaticResource AccentButtonStyle}"/>

                        <Button Content="âš¡ Auto-Isi Bahan &amp; Harga" 
                                Command="{Binding AutoGenerateIngredientsCommand}" 
                                Style="{StaticResource AccentButtonStyle}"
                                Background="Purple"/>

                        <TextBlock Text="AI sedang bekerja..." 
                                   Visibility="{Binding IsAiLoading, Converter={StaticResource BoolVisConv}}"
                                   VerticalAlignment="Center" 
                                   FontStyle="Italic" 
                                   Foreground="Orange"/>
                    </StackPanel>

                    <TextBox Grid.Row="1" 
                             Text="{Binding SelectedRecipe.Description, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                             AcceptsReturn="True" 
                             TextWrapping="Wrap" 
                             Margin="0,12,0,0" 
                             PlaceholderText="Deskripsi marketing atau catatan resep akan muncul di sini..."
                             BorderThickness="0" Background="Transparent"/>
                </Grid>
            </StackPanel>

            <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="12" Margin="0,0,0,24" Background="{ThemeResource SystemControlBackgroundBaseLowBrush}" Padding="12" CornerRadius="8">
                <ComboBox Header="Pilih Bahan" 
                          ItemsSource="{Binding AvailableIngredients}" 
                          SelectedItem="{Binding SelectedIngredientToAdd, Mode=TwoWay}"
                          DisplayMemberPath="Name"
                          Width="200"/>

                <TextBox Header="Qty" Text="{Binding UsageQtyInput, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="80"/>

                <ComboBox Header="Satuan" 
                          ItemsSource="{Binding UnitOptions}" 
                          SelectedItem="{Binding SelectedUsageUnit, Mode=TwoWay}"
                          Width="100"/>

                <Button Content="âž• Tambah" Command="{Binding AddItemToRecipeCommand}" VerticalAlignment="Bottom"/>
            </StackPanel>

            <ListView Grid.Row="2" ItemsSource="{Binding SelectedRecipe.Items}">
                <ListView.Header>
                    <Grid Padding="12" Background="{ThemeResource SystemControlBackgroundBaseLowBrush}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="150"/>
                            <ColumnDefinition Width="50"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Bahan" FontWeight="Bold" Grid.Column="0"/>
                        <TextBlock Text="Qty Pakai" FontWeight="Bold" Grid.Column="1"/>
                        <TextBlock Text="Subtotal (HPP)" FontWeight="Bold" Grid.Column="2"/>
                        <TextBlock Text="" Grid.Column="3"/>
                    </Grid>
                </ListView.Header>
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="12" BorderThickness="0,0,0,1" BorderBrush="{ThemeResource SystemControlBackgroundBaseLowBrush}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="100"/>
                                <ColumnDefinition Width="150"/>
                                <ColumnDefinition Width="50"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Text="{Binding Ingredient.Name}" Grid.Column="0" VerticalAlignment="Center"/>

                            <StackPanel Orientation="Horizontal" Grid.Column="1" VerticalAlignment="Center">
                                <TextBlock Text="{Binding UsageQty}"/>
                                <TextBlock Text="{Binding UsageUnit}" Margin="4,0,0,0" Opacity="0.6"/>
                            </StackPanel>

                            <TextBlock Text="{Binding CalculatedCost, Converter={StaticResource MoneyConv}}" 
                                       Grid.Column="2" VerticalAlignment="Center" Foreground="Green"/>

                            <Button Grid.Column="3" Content="ðŸ—‘ï¸" 
                                    Command="{Binding DataContext.RemoveItemFromRecipeCommand, ElementName=RootPage}" 
                                    CommandParameter="{Binding}"
                                    Background="Transparent"/>
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

            <StackPanel Grid.Row="3" Background="{ThemeResource SystemControlBackgroundChromeMediumLowBrush}" Padding="20" CornerRadius="8" Margin="0,12,0,0">
                <TextBlock Text="KALKULASI PROFIT" FontWeight="Bold" Margin="0,0,0,12"/>
                <Grid ColumnSpacing="20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <TextBlock Text="Total Modal (Batch)" Opacity="0.6"/>
                        <TextBlock Text="{Binding SelectedRecipe.TotalCost, Converter={StaticResource MoneyConv}}" 
                                   FontSize="24" Foreground="Red"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1">
                        <TextBlock Text="HPP Per Porsi" Opacity="0.6"/>
                        <TextBlock Text="{Binding SelectedRecipe.CostPerUnit, Converter={StaticResource MoneyConv}}" 
                                   FontSize="24" Foreground="Orange"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2">
                        <TextBlock Text="Harga Jual (Saran)" Opacity="0.6"/>
                        <TextBlock Text="{Binding SelectedRecipe.SuggestedPrice, Converter={StaticResource MoneyConv}}" 
                                   FontSize="24" Foreground="Green" FontWeight="Bold"/>
                    </StackPanel>
                </Grid>
            </StackPanel>
        </Grid>
    </Grid>
</Page>